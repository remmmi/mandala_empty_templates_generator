name: Build and Release

# Trigger: automatically runs when a tag starting with 'v' is pushed (e.g., v1.0.1)
on:
  push:
    tags:
      - 'v*'

# Required permissions for creating releases and uploading assets
permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      # ========================================================================
      # 1. SETUP: Checkout code and extract version
      # ========================================================================
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_ENV
          Write-Host "Extracted version: $version"

      # ========================================================================
      # 2. PYTHON SETUP: Install Python and dependencies
      # ========================================================================
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyQt6 Pillow reportlab pyinstaller

      - name: Verify Python packages
        run: |
          python -c "import PyQt6, PIL, reportlab; print('All packages imported successfully')"

      # ========================================================================
      # 3. BUILD EXE: Use PyInstaller to create the Windows executable
      # ========================================================================
      - name: Build EXE with PyInstaller
        run: |
          pyinstaller --onefile --windowed --name "Mandala PDF Generator" `
            --hidden-import=multiprocessing `
            --hidden-import=multiprocessing.spawn `
            --hidden-import=PIL._tkinter_finder `
            gui_pdf_generator.py

      - name: Verify EXE build
        shell: pwsh
        run: |
          $exePath = "dist\Mandala PDF Generator.exe"
          if (Test-Path $exePath) {
            $size = (Get-Item $exePath).Length / 1MB
            Write-Host "‚úÖ EXE built successfully: $([Math]::Round($size, 2)) MB"
          } else {
            Write-Host "‚ùå ERROR: EXE not found at $exePath"
            exit 1
          }

      # ========================================================================
      # 4. INNO SETUP: Install and compile the installer
      # ========================================================================
      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y
          # Add Inno Setup to PATH for this session
          $innoPath = "C:\Program Files (x86)\Inno Setup 6"
          echo "$innoPath" >> $env:GITHUB_PATH
          Write-Host "Inno Setup installed"

      - name: Compile installer with Inno Setup
        shell: pwsh
        run: |
          $version = "${{ env.VERSION }}"
          Write-Host "Compiling installer for version $version..."

          # Run Inno Setup compiler with version parameter
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DAppVersion=$version installer.iss

          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Inno Setup compilation failed"
            exit 1
          }

          Write-Host "‚úÖ Installer compiled successfully"

      - name: Verify installer output
        shell: pwsh
        run: |
          $setupFile = Get-ChildItem -Path "installer_output" -Filter "*.exe" | Select-Object -First 1
          if ($setupFile) {
            $size = $setupFile.Length / 1MB
            Write-Host "‚úÖ Installer found: $($setupFile.Name) ($([Math]::Round($size, 2)) MB)"
          } else {
            Write-Host "‚ùå ERROR: No installer found in installer_output/"
            exit 1
          }

      # ========================================================================
      # 5. PACKAGE: Create ZIP archive for distribution
      # ========================================================================
      - name: Create ZIP archive
        shell: pwsh
        run: |
          $version = "${{ env.VERSION }}"
          $setupFile = Get-ChildItem -Path "installer_output" -Filter "*.exe" | Select-Object -First 1
          $zipName = "Mandala-PDF-Generator-v$version.zip"

          # Create a README for the ZIP (using array to avoid YAML parsing issues)
          $readmeLines = @(
            "Mandala PDF Generator v$version",
            "================================",
            "",
            "Thank you for downloading Mandala PDF Generator!",
            "",
            "Installation:",
            "1. Extract this ZIP file",
            "2. Run the setup executable: $($setupFile.Name)",
            "3. Follow the installation wizard",
            "4. Launch the application from your Start Menu or Desktop",
            "",
            "Source Code:",
            "The complete source code is available on GitHub:",
            "https://github.com/remmmi/mandala_empty_templates_generator",
            "",
            "For documentation and support, please visit the GitHub repository.",
            "",
            "License: See LICENSE file in the repository"
          )
          $readmeContent = $readmeLines -join "`r`n"
          Set-Content -Path "installer_output\README.txt" -Value $readmeContent

          # Create ZIP with installer and README
          Compress-Archive -Path "installer_output\*" -DestinationPath $zipName

          $zipSize = (Get-Item $zipName).Length / 1MB
          Write-Host "‚úÖ ZIP created: $zipName ($([Math]::Round($zipSize, 2)) MB)"

      # ========================================================================
      # 6. PACKAGE SOURCE: Create source ZIP with Python code
      # ========================================================================
      - name: Create source ZIP for Python users
        shell: pwsh
        run: |
          $version = "${{ env.VERSION }}"
          $sourceZipName = "Mandala-PDF-Generator-Source-v$version.zip"

          # Create a temporary directory for the source package
          $sourceDir = "source_package"
          New-Item -ItemType Directory -Path $sourceDir -Force | Out-Null

          # Copy source files
          Copy-Item "*.py" -Destination $sourceDir
          Copy-Item "requirements.txt" -Destination $sourceDir
          Copy-Item "INSTALLATION.md" -Destination $sourceDir
          Copy-Item "README.md" -Destination $sourceDir
          Copy-Item "LICENSE" -Destination $sourceDir
          Copy-Item "zoo" -Destination $sourceDir -Recurse -ErrorAction SilentlyContinue

          # Create a quick start batch file
          $batchContent = @(
            "@echo off",
            "echo ================================================",
            "echo Mandala PDF Generator v$version",
            "echo ================================================",
            "echo.",
            "echo Verification de Python...",
            "python --version >nul 2>&1",
            "if errorlevel 1 (",
            "    echo ERREUR: Python n'est pas installe ou pas dans le PATH",
            "    echo Consultez INSTALLATION.md pour les instructions",
            "    pause",
            "    exit /b 1",
            ")",
            "echo.",
            "echo Installation des dependances...",
            "python -m pip install -r requirements.txt",
            "if errorlevel 1 (",
            "    echo ERREUR lors de l'installation des dependances",
            "    pause",
            "    exit /b 1",
            ")",
            "echo.",
            "echo Lancement de l'application...",
            "python gui_pdf_generator.py",
            "pause"
          )
          $batchContent -join "`r`n" | Set-Content -Path "$sourceDir\LANCER.bat" -Encoding ASCII

          # Create ZIP
          Compress-Archive -Path "$sourceDir\*" -DestinationPath $sourceZipName -Force

          $sourceZipSize = (Get-Item $sourceZipName).Length / 1MB
          Write-Host "‚úÖ Source ZIP created: $sourceZipName ($([Math]::Round($sourceZipSize, 2)) MB)"

      # ========================================================================
      # 7. RELEASE: Create GitHub release with both ZIPs
      # ========================================================================
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Mandala-PDF-Generator-v${{ env.VERSION }}.zip
            Mandala-PDF-Generator-Source-v${{ env.VERSION }}.zip
          body: |
            ## Mandala PDF Generator v${{ env.VERSION }}

            Choisissez la version qui vous convient :

            ### üì¶ Option 1 : Installeur Windows (Recommand√© pour la plupart des utilisateurs)

            **Fichier** : `Mandala-PDF-Generator-v${{ env.VERSION }}.zip`

            **Pour qui** : Utilisateurs qui veulent une installation simple et rapide

            **Installation** :
            1. T√©l√©chargez le ZIP ci-dessous
            2. Extrayez-le dans un dossier
            3. Lancez le fichier `Mandala-PDF-Generator-Setup-v${{ env.VERSION }}.exe`
            4. Suivez l'assistant d'installation
            5. L'application sera disponible dans votre menu D√©marrer

            **Inclus** :
            - Installation automatique
            - Raccourcis menu D√©marrer et bureau
            - D√©sinstallation propre via Param√®tres Windows

            **Note Windows SmartScreen** : Comme cette application n'est pas sign√©e num√©riquement (certificat payant), Windows peut afficher un avertissement. C'est normal pour les logiciels open source. Pour continuer :
            1. Cliquez sur "Informations compl√©mentaires"
            2. Cliquez sur "Ex√©cuter quand m√™me"

            ---

            ### üêç Option 2 : Code source Python (Pour d√©veloppeurs et utilisateurs avanc√©s)

            **Fichier** : `Mandala-PDF-Generator-Source-v${{ env.VERSION }}.zip`

            **Pour qui** :
            - Utilisateurs ayant Python install√©
            - D√©veloppeurs souhaitant modifier le code
            - Utilisateurs pr√©f√©rant ex√©cuter depuis le code source

            **Pr√©requis** : Python 3.8+ install√© sur votre syst√®me

            **Installation rapide** :
            1. T√©l√©chargez le ZIP source ci-dessous
            2. Extrayez-le dans un dossier
            3. Double-cliquez sur `LANCER.bat` (installe automatiquement les d√©pendances et lance l'application)

            **Installation manuelle d√©taill√©e** :
            Consultez le fichier `INSTALLATION.md` inclus dans le ZIP pour un guide complet pas-√†-pas destin√© aux d√©butants, incluant :
            - Installation de Python
            - Installation de pip
            - Installation des d√©pendances
            - Lancement de l'application
            - D√©pannage des probl√®mes courants

            **Inclus dans le ZIP source** :
            - Tous les fichiers Python (`.py`)
            - `requirements.txt` avec toutes les d√©pendances
            - `INSTALLATION.md` - Guide d√©taill√© pour d√©butants
            - `README.md` - Documentation technique
            - `LANCER.bat` - Script de lancement automatique
            - Dossier `zoo/` avec exemples de configurations

            ---

            ### üìö Documentation

            - **Code source complet** : Consultez le tag [${{ github.ref_name }}](https://github.com/remmmi/mandala_empty_templates_generator/tree/${{ github.ref_name }})
            - **Archives source GitHub** : Disponibles ci-dessous (tar.gz / zip auto-g√©n√©r√©s)
            - **Issues et support** : https://github.com/remmmi/mandala_empty_templates_generator/issues

            ---

            ### üîí V√©rification d'int√©grit√©

            Vous pouvez v√©rifier l'int√©grit√© des t√©l√©chargements en comparant le hash SHA256 des fichiers avec ceux list√©s dans les artifacts de la release.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ========================================================================
      # 7. CLEANUP: Upload artifacts for debugging (optional)
      # ========================================================================
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-artifacts-v${{ env.VERSION }}
          path: |
            dist/
            installer_output/
            build/
          retention-days: 30
